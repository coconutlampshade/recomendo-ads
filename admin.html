<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin â€” Recomendo Ads</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 20px 0; }

    /* Login */
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 100px auto;
    }
    .login-box h2 { margin: 0 0 20px 0; }
    .login-box input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .login-box button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #8fd14f;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .login-box button:hover { background: #7ac043; }
    .error { color: #e74c3c; margin-top: 10px; }

    /* Dashboard */
    .dashboard { display: none; }
    .dashboard.visible { display: block; }
    .login-box.hidden { display: none; }

    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 1;
    }
    .stat-card .number {
      font-size: 32px;
      font-weight: 700;
      color: #8fd14f;
    }
    .stat-card .label { color: #666; }

    .orders-table {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .orders-table h2 {
      margin: 0;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 15px 20px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th { background: #fafafa; font-weight: 600; }
    tr:hover { background: #fafafa; }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.premium { background: #ffe600; color: #333; }
    .badge.unclassified { background: #e0e0e0; color: #333; }

    .ad-copy {
      max-width: 300px;
      font-size: 13px;
      color: #555;
      line-height: 1.4;
    }
    .ad-url {
      font-size: 12px;
      color: #8fd14f;
      word-break: break-all;
    }
    .issue-date { white-space: nowrap; }

    .loading { text-align: center; padding: 40px; color: #666; }
    .no-orders { text-align: center; padding: 40px; color: #666; }

    .delete-btn {
      background: none;
      border: 1px solid #ddd;
      color: #999;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn:hover {
      background: #fee;
      border-color: #e74c3c;
      color: #e74c3c;
    }
    .delete-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .logout-btn {
      background: none;
      border: 1px solid #ddd;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      float: right;
    }
    .logout-btn:hover { background: #f5f5f5; }

    @media (max-width: 700px) {
      .stats-bar { flex-direction: column; }
      table { font-size: 14px; }
      th, td { padding: 10px; }
      .ad-copy { max-width: 150px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login -->
    <div class="login-box" id="loginBox">
      <h2>Admin Login</h2>
      <input type="password" id="password" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Login</button>
      <div class="error" id="loginError"></div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
      <h1>Upcoming Ads <button class="logout-btn" onclick="logout()">Logout</button></h1>

      <div class="stats-bar">
        <div class="stat-card">
          <div class="number" id="totalOrders">-</div>
          <div class="label">Total Bookings</div>
        </div>
        <div class="stat-card">
          <div class="number" id="totalRevenue">-</div>
          <div class="label">Revenue</div>
        </div>
        <div class="stat-card">
          <div class="number" id="upcomingAds">-</div>
          <div class="label">Upcoming Ads</div>
        </div>
      </div>

      <div class="orders-table">
        <h2>Ad Schedule</h2>
        <div id="ordersContent">
          <div class="loading">Loading orders...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://recomendo-ads-checkout.markfrauenfelder.workers.dev';

    function login() {
      const password = document.getElementById('password').value;
      if (!password) return;

      // Store password and try to fetch orders
      sessionStorage.setItem('adminPass', password);
      fetchOrders(password);
    }

    function logout() {
      sessionStorage.removeItem('adminPass');
      document.getElementById('loginBox').classList.remove('hidden');
      document.getElementById('dashboard').classList.remove('visible');
      document.getElementById('password').value = '';
    }

    async function fetchOrders(password) {
      try {
        const response = await fetch(`${WORKER_URL}/admin/orders`, {
          headers: {
            'Authorization': `Bearer ${password}`
          }
        });

        if (response.status === 401) {
          document.getElementById('loginError').textContent = 'Invalid password';
          sessionStorage.removeItem('adminPass');
          return;
        }

        if (!response.ok) throw new Error('Failed to fetch');

        const data = await response.json();

        // Show dashboard
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('dashboard').classList.add('visible');
        document.getElementById('loginError').textContent = '';

        renderOrders(data);
      } catch (err) {
        document.getElementById('loginError').textContent = 'Error connecting to server';
        console.error(err);
      }
    }

    function renderOrders(data) {
      const { orders, stats } = data;

      // Update stats
      document.getElementById('totalOrders').textContent = stats.totalOrders;
      document.getElementById('totalRevenue').textContent = '$' + stats.totalRevenue.toLocaleString();
      document.getElementById('upcomingAds').textContent = stats.upcomingAds;

      if (orders.length === 0) {
        document.getElementById('ordersContent').innerHTML = '<div class="no-orders">No orders yet</div>';
        return;
      }

      // Sort by issue date
      orders.sort((a, b) => new Date(a.issueDate) - new Date(b.issueDate));

      let html = `<table>
        <thead>
          <tr>
            <th>Issue Date</th>
            <th>Type</th>
            <th>Customer</th>
            <th>Ad Copy</th>
            <th>Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>`;

      for (const order of orders) {
        const badgeClass = order.type === 'premium' ? 'premium' : 'unclassified';
        const typeName = order.type === 'premium' ? 'Premium' : 'Unclassified';

        html += `<tr id="row-${order.adId}">
          <td class="issue-date">
            <strong>#${order.issueNumber}</strong><br>
            ${order.dateFormatted}
          </td>
          <td><span class="badge ${badgeClass}">${typeName}</span></td>
          <td>
            <strong>${escapeHtml(order.customerName)}</strong><br>
            <span style="color:#666;font-size:13px">${escapeHtml(order.customerEmail)}</span>
          </td>
          <td>
            <div class="ad-copy">${escapeHtml(order.adCopy)}</div>
            <a href="${escapeHtml(order.adUrl)}" target="_blank" class="ad-url">${escapeHtml(order.adUrl)}</a>
          </td>
          <td><strong>$${order.price}</strong></td>
          <td><button class="delete-btn" onclick="deleteAd('${order.adId}')">Delete</button></td>
        </tr>`;
      }

      html += '</tbody></table>';
      document.getElementById('ordersContent').innerHTML = html;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function deleteAd(adId) {
      if (!confirm('Delete this ad from the schedule? This cannot be undone.')) {
        return;
      }

      const password = sessionStorage.getItem('adminPass');
      if (!password) {
        alert('Please log in again');
        logout();
        return;
      }

      // Disable the button
      const btn = document.querySelector(`#row-${adId} .delete-btn`);
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Deleting...';
      }

      try {
        const response = await fetch(`${WORKER_URL}/admin/delete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ adId })
        });

        if (!response.ok) {
          throw new Error('Failed to delete');
        }

        // Remove the row from the table
        const row = document.getElementById(`row-${adId}`);
        if (row) {
          row.style.opacity = '0.5';
          row.style.textDecoration = 'line-through';
          setTimeout(() => row.remove(), 500);
        }

        // Update the upcoming ads count
        const countEl = document.getElementById('upcomingAds');
        const currentCount = parseInt(countEl.textContent) || 0;
        countEl.textContent = Math.max(0, currentCount - 1);

      } catch (err) {
        alert('Failed to delete ad');
        console.error(err);
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Delete';
        }
      }
    }

    // Check for saved session
    const savedPass = sessionStorage.getItem('adminPass');
    if (savedPass) {
      fetchOrders(savedPass);
    }
  </script>
</body>
</html>
