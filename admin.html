<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin — Recomendo Ads</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 20px 0; }

    /* Login */
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 100px auto;
    }
    .login-box h2 { margin: 0 0 20px 0; }
    .login-box input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .login-box button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #8fd14f;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .login-box button:hover { background: #7ac043; }
    .error { color: #e74c3c; margin-top: 10px; }

    /* Dashboard */
    .dashboard { display: none; }
    .dashboard.visible { display: block; }
    .login-box.hidden { display: none; }

    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 1;
    }
    .stat-card .number {
      font-size: 32px;
      font-weight: 700;
      color: #8fd14f;
    }
    .stat-card .label { color: #666; }

    .orders-table {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .orders-table h2 {
      margin: 0;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 15px 20px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th { background: #fafafa; font-weight: 600; }
    tr:hover { background: #fafafa; }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.premium { background: #ffe600; color: #333; }
    .badge.unclassified { background: #e0e0e0; color: #333; }

    .ad-copy {
      max-width: 300px;
      font-size: 13px;
      color: #555;
      line-height: 1.4;
    }
    .ad-copy a {
      color: #8fd14f;
      text-decoration: underline;
    }
    .issue-date { white-space: nowrap; }

    .loading { text-align: center; padding: 40px; color: #666; }
    .no-orders { text-align: center; padding: 40px; color: #666; }

    .action-btn {
      background: none;
      border: 1px solid #ddd;
      color: #666;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 4px;
      margin-bottom: 4px;
    }
    .action-btn:hover {
      background: #f5f5f5;
      border-color: #999;
    }
    .action-btn.copy:hover {
      background: #e8f5e9;
      border-color: #8fd14f;
      color: #333;
    }
    .action-btn.edit:hover {
      background: #fff8e1;
      border-color: #f9a825;
      color: #333;
    }
    .action-btn.email:hover {
      background: #e3f2fd;
      border-color: #2196f3;
      color: #1976d2;
    }
    .action-btn.delete:hover {
      background: #fee;
      border-color: #e74c3c;
      color: #e74c3c;
    }
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .actions-cell {
      white-space: nowrap;
    }

    /* Edit Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.visible {
      display: flex;
    }
    .modal {
      background: white;
      border-radius: 8px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h3 {
      margin: 0 0 16px 0;
    }
    .modal .form-group {
      margin-bottom: 16px;
    }
    .modal label {
      display: block;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      color: #555;
    }
    .modal input, .modal textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }
    .modal textarea {
      min-height: 100px;
      resize: vertical;
    }
    .modal-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    .modal-btn {
      padding: 10px 20px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .modal-btn.cancel {
      background: #f5f5f5;
      border: 1px solid #ddd;
      color: #666;
    }
    .modal-btn.save {
      background: #8fd14f;
      border: none;
      color: #333;
    }
    .modal-btn.save:hover {
      background: #7ac043;
    }

    .logout-btn {
      background: none;
      border: 1px solid #ddd;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      float: right;
    }
    .logout-btn:hover { background: #f5f5f5; }

    @media (max-width: 700px) {
      .stats-bar { flex-direction: column; }
      table { font-size: 14px; }
      th, td { padding: 10px; }
      .ad-copy { max-width: 150px; }
    }

    /* Config Editor */
    .config-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 30px;
      overflow: hidden;
    }
    .config-section h2 {
      margin: 0;
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .config-content { padding: 20px; }
    .config-group {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #eee;
    }
    .config-group:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .config-group h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      text-transform: uppercase;
      color: #888;
      letter-spacing: 0.5px;
    }
    .config-row {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }
    .config-field {
      flex: 1;
    }
    .config-field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #555;
    }
    .config-field input, .config-field textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }
    .config-field textarea {
      min-height: 80px;
      resize: vertical;
    }
    .config-field input:focus, .config-field textarea:focus {
      outline: none;
      border-color: #8fd14f;
    }
    .testimonial-card-edit {
      background: #f9f9f9;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
    }
    .testimonial-card-edit .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 18px;
    }
    .testimonial-card-edit .remove-btn:hover { color: #e74c3c; }
    .add-testimonial-btn {
      background: #f5f5f5;
      border: 2px dashed #ddd;
      padding: 12px;
      border-radius: 6px;
      width: 100%;
      cursor: pointer;
      font-size: 14px;
      color: #666;
    }
    .add-testimonial-btn:hover {
      border-color: #8fd14f;
      color: #333;
    }
    .save-config-btn {
      background: #8fd14f;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
    .save-config-btn:hover { background: #7ac043; }
    .save-config-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .save-status {
      display: inline-block;
      margin-left: 12px;
      font-size: 14px;
    }
    .save-status.success { color: #27ae60; }
    .save-status.error { color: #e74c3c; }

    /* Time Filter (Upcoming/Past) */
    .time-filter {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .time-filter button {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      color: #666;
    }
    .time-filter button.active {
      background: #333;
      border-color: #333;
      color: white;
    }
    .time-filter button .count {
      background: rgba(0,0,0,0.1);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
      margin-left: 4px;
    }
    .time-filter button.active .count {
      background: rgba(255,255,255,0.2);
    }

    /* View Toggle */
    .view-toggle {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
    }
    .view-toggle button {
      padding: 10px 20px;
      border: 1px solid #ddd;
      background: #f5f5f5;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
    }
    .view-toggle button:first-child {
      border-radius: 4px 0 0 4px;
    }
    .view-toggle button:last-child {
      border-radius: 0 4px 4px 0;
      border-left: none;
    }
    .view-toggle button.active {
      background: #8fd14f;
      border-color: #8fd14f;
      color: #333;
    }

    /* Issue View */
    .issue-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .issue-header {
      background: #f8f8f8;
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .issue-title {
      font-weight: 700;
      font-size: 18px;
    }
    .issue-title span {
      color: #666;
      font-weight: 400;
      font-size: 14px;
      margin-left: 8px;
    }
    .issue-meta {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .issue-count {
      background: #e8e8e8;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: #666;
    }
    .copy-all-btn {
      background: #8fd14f;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
    }
    .copy-all-btn:hover { background: #7ac043; }
    .issue-ads {
      padding: 16px 20px;
    }
    .issue-ad-item {
      display: flex;
      gap: 16px;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
      align-items: flex-start;
    }
    .issue-ad-item:last-child {
      border-bottom: none;
    }
    .issue-ad-type {
      min-width: 100px;
    }
    .issue-ad-content {
      flex: 1;
      font-size: 14px;
      line-height: 1.5;
    }
    .issue-ad-content a {
      color: #8fd14f;
      text-decoration: underline;
    }
    .issue-ad-customer {
      min-width: 150px;
      font-size: 13px;
      color: #666;
      text-align: right;
    }
    .issue-ad-actions {
      display: flex;
      gap: 4px;
    }
    #listView, #issueView {
      display: none;
    }
    #listView.active, #issueView.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login -->
    <div class="login-box" id="loginBox">
      <h2>Admin Login</h2>
      <input type="password" id="password" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Login</button>
      <div class="error" id="loginError"></div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
      <h1>Upcoming Ads <button class="logout-btn" onclick="logout()">Logout</button></h1>

      <div class="stats-bar">
        <div class="stat-card">
          <div class="number" id="totalOrders">-</div>
          <div class="label">Total Bookings</div>
        </div>
        <div class="stat-card">
          <div class="number" id="totalRevenue">-</div>
          <div class="label">Revenue</div>
        </div>
        <div class="stat-card">
          <div class="number" id="upcomingAds">-</div>
          <div class="label">Upcoming Ads</div>
        </div>
      </div>

      <div class="time-filter">
        <button class="active" onclick="switchTimeFilter('upcoming')">
          Upcoming <span class="count" id="upcomingCount">0</span>
        </button>
        <button onclick="switchTimeFilter('past')">
          Past <span class="count" id="pastCount">0</span>
        </button>
      </div>

      <div class="view-toggle">
        <button class="active" onclick="switchView('list')">List View</button>
        <button onclick="switchView('issue')">Issue View</button>
      </div>

      <!-- List View -->
      <div id="listView" class="active">
        <div class="orders-table">
          <h2>Ad Schedule</h2>
          <div id="ordersContent">
            <div class="loading">Loading orders...</div>
          </div>
        </div>
      </div>

      <!-- Issue View -->
      <div id="issueView">
        <div id="issueViewContent">
          <div class="loading">Loading orders...</div>
        </div>
      </div>

      <!-- Site Settings -->
      <div class="config-section">
        <h2>
          Site Settings
          <div>
            <button class="save-config-btn" onclick="saveConfig()">Save Changes</button>
            <span class="save-status" id="saveStatus"></span>
          </div>
        </h2>
        <div class="config-content">
          <!-- Stats -->
          <div class="config-group">
            <h3>Newsletter Stats</h3>
            <div class="config-row">
              <div class="config-field">
                <label>Subscribers</label>
                <input type="text" id="cfg-subscribers" placeholder="e.g. 122,000+">
              </div>
              <div class="config-field">
                <label>Open Rate</label>
                <input type="text" id="cfg-openrate" placeholder="e.g. 46%">
              </div>
            </div>
          </div>

          <!-- Contact -->
          <div class="config-group">
            <h3>Contact</h3>
            <div class="config-row">
              <div class="config-field">
                <label>Contact Email</label>
                <input type="email" id="cfg-email" placeholder="e.g. editor@kk.org">
              </div>
            </div>
          </div>

          <!-- Testimonials -->
          <div class="config-group">
            <h3>Testimonials</h3>
            <div id="testimonialsList"></div>
            <button class="add-testimonial-btn" onclick="addTestimonial()">+ Add Testimonial</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
      <div class="modal">
        <h3>Edit Ad</h3>
        <input type="hidden" id="edit-adId">
        <div class="form-group">
          <label>Ad Copy</label>
          <textarea id="edit-adCopy" placeholder="Use **bold** and [[link text]]"></textarea>
        </div>
        <div class="form-group">
          <label>Destination URL</label>
          <input type="url" id="edit-adUrl" placeholder="https://example.com">
        </div>
        <div class="form-group">
          <label>Preview</label>
          <div id="edit-preview" style="background:#f5f5f5;padding:12px;border-radius:4px;font-size:14px;line-height:1.5;min-height:40px;"></div>
        </div>
        <div class="modal-buttons">
          <button class="modal-btn cancel" onclick="closeEditModal()">Cancel</button>
          <button class="modal-btn save" onclick="saveEdit()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://recomendo-ads-checkout.markfrauenfelder.workers.dev';

    function login() {
      const password = document.getElementById('password').value;
      if (!password) return;

      // Store password and try to fetch orders
      sessionStorage.setItem('adminPass', password);
      fetchOrders(password);
      fetchConfig();
    }

    function logout() {
      sessionStorage.removeItem('adminPass');
      document.getElementById('loginBox').classList.remove('hidden');
      document.getElementById('dashboard').classList.remove('visible');
      document.getElementById('password').value = '';
    }

    async function fetchOrders(password) {
      try {
        const response = await fetch(`${WORKER_URL}/admin/orders`, {
          headers: {
            'Authorization': `Bearer ${password}`
          }
        });

        if (response.status === 401) {
          document.getElementById('loginError').textContent = 'Invalid password';
          sessionStorage.removeItem('adminPass');
          return;
        }

        if (!response.ok) throw new Error('Failed to fetch');

        const data = await response.json();

        // Show dashboard
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('dashboard').classList.add('visible');
        document.getElementById('loginError').textContent = '';

        // Store data globally for filtering
        window.allOrdersData = data;
        renderOrders(data);
      } catch (err) {
        document.getElementById('loginError').textContent = 'Error connecting to server';
        console.error(err);
      }
    }

    let currentTimeFilter = 'upcoming';

    function switchTimeFilter(filter) {
      currentTimeFilter = filter;
      const buttons = document.querySelectorAll('.time-filter button');
      buttons.forEach(btn => btn.classList.remove('active'));
      buttons[filter === 'upcoming' ? 0 : 1].classList.add('active');

      if (window.allOrdersData) {
        renderOrdersList(filter === 'upcoming' ? window.allOrdersData.orders : window.allOrdersData.pastOrders);
        renderIssueView(filter === 'upcoming' ? window.allOrdersData.orders : window.allOrdersData.pastOrders);
      }
    }

    function renderOrders(data) {
      const { orders, pastOrders = [], stats } = data;

      // Update stats
      document.getElementById('totalOrders').textContent = stats.totalOrders;
      document.getElementById('totalRevenue').textContent = '$' + stats.totalRevenue.toLocaleString();
      document.getElementById('upcomingAds').textContent = stats.upcomingAds;

      // Update time filter counts
      document.getElementById('upcomingCount').textContent = orders.length;
      document.getElementById('pastCount').textContent = pastOrders.length;

      // Store all order data for copy/edit
      window.orderData = window.orderData || {};
      for (const order of [...orders, ...pastOrders]) {
        window.orderData[order.adId] = order;
      }

      // Render current filter
      const currentOrders = currentTimeFilter === 'upcoming' ? orders : pastOrders;
      renderOrdersList(currentOrders);
      renderIssueView(currentOrders);
    }

    function renderOrdersList(orders) {
      if (orders.length === 0) {
        document.getElementById('ordersContent').innerHTML = `<div class="no-orders">No ${currentTimeFilter} ads</div>`;
        return;
      }

      // Sort by issue date (ascending for upcoming, already descending for past)
      if (currentTimeFilter === 'upcoming') {
        orders.sort((a, b) => new Date(a.issueDate) - new Date(b.issueDate));
      }

      let html = `<table>
        <thead>
          <tr>
            <th>Issue Date</th>
            <th>Type</th>
            <th>Customer</th>
            <th>Ad Copy</th>
            <th>Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>`;

      for (const order of orders) {
        const badgeClass = order.type === 'premium' ? 'premium' : 'unclassified';
        const typeName = order.type === 'premium' ? 'Premium' : 'Unclassified';

        html += `<tr id="row-${order.adId}">
          <td class="issue-date">
            <strong>#${order.issueNumber}</strong><br>
            ${order.dateFormatted}
          </td>
          <td><span class="badge ${badgeClass}">${typeName}</span></td>
          <td>
            <strong>${escapeHtml(order.customerName)}</strong><br>
            <span style="color:#666;font-size:13px">${escapeHtml(order.customerEmail)}</span>
          </td>
          <td>
            <div class="ad-copy" id="adcopy-${order.adId}">${formatAdCopy(order.adCopy, order.adUrl)}</div>
          </td>
          <td><strong>$${order.price}</strong></td>
          <td class="actions-cell">
            <button class="action-btn copy" onclick="copyAd('${order.adId}')">Copy</button>
            <button class="action-btn edit" onclick="editAd('${order.adId}')">Edit</button>
            <button class="action-btn email" onclick="emailCustomer('${order.adId}')">Email</button>
            <button class="action-btn delete" onclick="deleteAd('${order.adId}')">Delete</button>
          </td>
        </tr>`;
      }

      html += '</tbody></table>';
      document.getElementById('ordersContent').innerHTML = html;
    }

    function renderIssueView(orders) {
      if (orders.length === 0) {
        document.getElementById('issueViewContent').innerHTML = `<div class="no-orders">No ${currentTimeFilter} ads</div>`;
        return;
      }

      // Group orders by issue number
      const issueGroups = {};
      for (const order of orders) {
        const key = order.issueNumber;
        if (!issueGroups[key]) {
          issueGroups[key] = {
            issueNumber: order.issueNumber,
            dateFormatted: order.dateFormatted,
            issueDate: order.issueDate,
            ads: []
          };
        }
        issueGroups[key].ads.push(order);
      }

      // Sort issues by date
      const sortedIssues = Object.values(issueGroups).sort((a, b) =>
        new Date(a.issueDate) - new Date(b.issueDate)
      );

      let html = '';
      for (const issue of sortedIssues) {
        const premiumCount = issue.ads.filter(a => a.type === 'premium').length;
        const unclassifiedCount = issue.ads.filter(a => a.type === 'unclassified').length;

        html += `
          <div class="issue-card" data-issue="${issue.issueNumber}">
            <div class="issue-header">
              <div class="issue-title">
                Issue #${issue.issueNumber}
                <span>${issue.dateFormatted}</span>
              </div>
              <div class="issue-meta">
                <span class="issue-count">
                  ${premiumCount ? premiumCount + ' Premium' : ''}
                  ${premiumCount && unclassifiedCount ? ' · ' : ''}
                  ${unclassifiedCount ? unclassifiedCount + ' Unclassified' : ''}
                </span>
                <button class="copy-all-btn" onclick="copyAllForIssue('${issue.issueNumber}')">Copy All</button>
              </div>
            </div>
            <div class="issue-ads">`;

        // Sort ads: premium first, then unclassified
        const sortedAds = [...issue.ads].sort((a, b) => {
          if (a.type === 'premium' && b.type !== 'premium') return -1;
          if (a.type !== 'premium' && b.type === 'premium') return 1;
          return 0;
        });

        for (const ad of sortedAds) {
          const badgeClass = ad.type === 'premium' ? 'premium' : 'unclassified';
          const typeName = ad.type === 'premium' ? 'Premium' : 'Unclassified';

          html += `
              <div class="issue-ad-item">
                <div class="issue-ad-type">
                  <span class="badge ${badgeClass}">${typeName}</span>
                </div>
                <div class="issue-ad-content">${formatAdCopy(ad.adCopy, ad.adUrl)}</div>
                <div class="issue-ad-customer">${escapeHtml(ad.customerName)}</div>
                <div class="issue-ad-actions">
                  <button class="action-btn copy" onclick="copyAd('${ad.adId}')" title="Copy">Copy</button>
                  <button class="action-btn edit" onclick="editAd('${ad.adId}')" title="Edit">Edit</button>
                  <button class="action-btn email" onclick="emailCustomer('${ad.adId}')" title="Email">Email</button>
                </div>
              </div>`;
        }

        html += `
            </div>
          </div>`;
      }

      document.getElementById('issueViewContent').innerHTML = html;
    }

    function switchView(view) {
      const listView = document.getElementById('listView');
      const issueView = document.getElementById('issueView');
      const buttons = document.querySelectorAll('.view-toggle button');

      buttons.forEach(btn => btn.classList.remove('active'));

      if (view === 'list') {
        listView.classList.add('active');
        issueView.classList.remove('active');
        buttons[0].classList.add('active');
      } else {
        listView.classList.remove('active');
        issueView.classList.add('active');
        buttons[1].classList.add('active');
      }
    }

    function copyAllForIssue(issueNumber) {
      // Find all ads for this issue
      const ads = Object.values(window.orderData || {}).filter(
        order => String(order.issueNumber) === String(issueNumber)
      );

      if (ads.length === 0) return;

      // Sort: premium first
      ads.sort((a, b) => {
        if (a.type === 'premium' && b.type !== 'premium') return -1;
        if (a.type !== 'premium' && b.type === 'premium') return 1;
        return 0;
      });

      // Build HTML for all ads
      let html = '';
      for (const ad of ads) {
        let adHtml = ad.adCopy;
        // Convert **bold** to <b>
        adHtml = adHtml.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');

        // Check if there's a [[link]] in the copy
        if (adHtml.includes('[[') && adHtml.includes(']]')) {
          adHtml = adHtml.replace(/\[\[(.+?)\]\]/g, `<a href="${ad.adUrl}">$1</a>`);
        } else if (ad.adUrl) {
          // No [[link]] syntax - append URL as a link at the end
          const displayUrl = ad.adUrl.replace(/^https?:\/\//, '').replace(/\/$/, '');
          adHtml += ` <a href="${ad.adUrl}">${displayUrl}</a>`;
        }

        if (ad.type === 'premium') {
          html += `<p><strong>[SPONSOR]</strong> ${adHtml}</p>\n`;
        } else {
          html += `<p>${adHtml}</p>\n`;
        }
      }

      // Copy as HTML
      const blob = new Blob([html], { type: 'text/html' });
      const plainBlob = new Blob([html], { type: 'text/plain' });

      navigator.clipboard.write([
        new ClipboardItem({
          'text/html': blob,
          'text/plain': plainBlob
        })
      ]).then(() => {
        const btn = document.querySelector(`.issue-card[data-issue="${issueNumber}"] .copy-all-btn`);
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = '#7ac043';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 1500);
      }).catch(err => {
        console.error('Copy failed:', err);
        navigator.clipboard.writeText(html);
        alert('Copied as plain text');
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatAdCopy(text, url) {
      if (!text) return '';
      // Escape HTML first
      let formatted = escapeHtml(text);
      // Convert **text** to <strong>text</strong>
      formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Convert [[text]] to a link
      if (url) {
        formatted = formatted.replace(/\[\[(.+?)\]\]/g, `<a href="${escapeHtml(url)}" target="_blank">$1</a>`);
      } else {
        formatted = formatted.replace(/\[\[(.+?)\]\]/g, '<span style="color:#8fd14f;text-decoration:underline;">$1</span>');
      }
      return formatted;
    }

    async function deleteAd(adId) {
      if (!confirm('Delete this ad from the schedule? This cannot be undone.')) {
        return;
      }

      const password = sessionStorage.getItem('adminPass');
      if (!password) {
        alert('Please log in again');
        logout();
        return;
      }

      // Disable the button
      const btn = document.querySelector(`#row-${adId} .delete-btn`);
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Deleting...';
      }

      try {
        const response = await fetch(`${WORKER_URL}/admin/delete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ adId })
        });

        if (!response.ok) {
          throw new Error('Failed to delete');
        }

        // Remove the row from the table
        const row = document.getElementById(`row-${adId}`);
        if (row) {
          row.style.opacity = '0.5';
          row.style.textDecoration = 'line-through';
          setTimeout(() => row.remove(), 500);
        }

        // Update the upcoming ads count
        const countEl = document.getElementById('upcomingAds');
        const currentCount = parseInt(countEl.textContent) || 0;
        countEl.textContent = Math.max(0, currentCount - 1);

      } catch (err) {
        alert('Failed to delete ad');
        console.error(err);
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Delete';
        }
      }
    }

    // ============================================
    // COPY AD
    // ============================================

    function copyAd(adId) {
      const order = window.orderData[adId];
      if (!order) return;

      // Format for newsletter: convert **bold** and [[link]] to HTML
      let html = order.adCopy;
      html = html.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');

      // Check if there's a [[link]] in the copy
      if (html.includes('[[') && html.includes(']]')) {
        html = html.replace(/\[\[(.+?)\]\]/g, `<a href="${order.adUrl}">$1</a>`);
      } else if (order.adUrl) {
        // No [[link]] syntax - append URL as a link at the end
        const displayUrl = order.adUrl.replace(/^https?:\/\//, '').replace(/\/$/, '');
        html += ` <a href="${order.adUrl}">${displayUrl}</a>`;
      }

      // Copy as HTML to clipboard
      const blob = new Blob([html], { type: 'text/html' });
      const plainBlob = new Blob([html], { type: 'text/plain' });

      navigator.clipboard.write([
        new ClipboardItem({
          'text/html': blob,
          'text/plain': plainBlob
        })
      ]).then(() => {
        // Show feedback
        const btn = document.querySelector(`#row-${adId} .action-btn.copy`);
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = '#e8f5e9';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 1500);
      }).catch(err => {
        console.error('Copy failed:', err);
        // Fallback: copy plain text
        navigator.clipboard.writeText(html);
        alert('Copied as plain text (HTML copy not supported in this browser)');
      });
    }

    // ============================================
    // EMAIL CUSTOMER
    // ============================================

    function emailCustomer(adId) {
      const order = window.orderData[adId];
      if (!order) return;

      const subject = `Your Recomendo Ad - Issue #${order.issueNumber}`;
      const body = `Hi ${order.customerName},

I'm writing about your Recomendo ad scheduled for Issue #${order.issueNumber} (${order.dateFormatted}).

Your ad copy:
${order.adCopy}

Link: ${order.adUrl}

`;

      const mailto = `mailto:${order.customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;
    }

    // ============================================
    // EDIT AD
    // ============================================

    function editAd(adId) {
      const order = window.orderData[adId];
      if (!order) return;

      document.getElementById('edit-adId').value = adId;
      document.getElementById('edit-adCopy').value = order.adCopy;
      document.getElementById('edit-adUrl').value = order.adUrl;
      updateEditPreview();

      document.getElementById('editModal').classList.add('visible');

      // Update preview on input
      document.getElementById('edit-adCopy').oninput = updateEditPreview;
      document.getElementById('edit-adUrl').oninput = updateEditPreview;
    }

    function updateEditPreview() {
      const adCopy = document.getElementById('edit-adCopy').value;
      const adUrl = document.getElementById('edit-adUrl').value;
      document.getElementById('edit-preview').innerHTML = formatAdCopy(adCopy, adUrl) || '<span style="color:#999">Preview will appear here...</span>';
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('visible');
    }

    async function saveEdit() {
      const adId = document.getElementById('edit-adId').value;
      const adCopy = document.getElementById('edit-adCopy').value;
      const adUrl = document.getElementById('edit-adUrl').value;

      const password = sessionStorage.getItem('adminPass');
      if (!password) {
        alert('Please log in again');
        return;
      }

      const saveBtn = document.querySelector('.modal-btn.save');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch(`${WORKER_URL}/admin/edit`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ adId, adCopy, adUrl })
        });

        if (!response.ok) {
          throw new Error('Failed to save');
        }

        // Update local data
        window.orderData[adId].adCopy = adCopy;
        window.orderData[adId].adUrl = adUrl;

        // Update the table cell
        document.getElementById(`adcopy-${adId}`).innerHTML = formatAdCopy(adCopy, adUrl);

        closeEditModal();
      } catch (err) {
        alert('Failed to save changes');
        console.error(err);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    }

    // Close modal on overlay click
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) closeEditModal();
    });

    // ============================================
    // CONFIG EDITOR
    // ============================================

    let currentConfig = null;

    async function fetchConfig() {
      const password = sessionStorage.getItem('adminPass');
      try {
        const response = await fetch(`${WORKER_URL}/config`);
        if (response.ok) {
          currentConfig = await response.json();
          renderConfigForm();
        }
      } catch (err) {
        console.error('Failed to fetch config:', err);
      }
    }

    function renderConfigForm() {
      if (!currentConfig) return;

      // Populate stats
      document.getElementById('cfg-subscribers').value = currentConfig.stats?.subscribers || '';
      document.getElementById('cfg-openrate').value = currentConfig.stats?.openRate || '';

      // Populate contact
      document.getElementById('cfg-email').value = currentConfig.contact?.email || '';

      // Populate testimonials
      renderTestimonials();
    }

    function renderTestimonials() {
      const container = document.getElementById('testimonialsList');
      const testimonials = currentConfig.testimonials || [];

      container.innerHTML = testimonials.map((t, i) => `
        <div class="testimonial-card-edit" data-index="${i}">
          <button class="remove-btn" onclick="removeTestimonial(${i})">&times;</button>
          <div class="config-field" style="margin-bottom:12px">
            <label>Quote</label>
            <textarea id="testimonial-quote-${i}" onchange="updateTestimonial(${i})">${escapeHtml(t.quote)}</textarea>
          </div>
          <div class="config-field">
            <label>Company</label>
            <input type="text" id="testimonial-company-${i}" value="${escapeHtml(t.company)}" onchange="updateTestimonial(${i})">
          </div>
        </div>
      `).join('');
    }

    function updateTestimonial(index) {
      const quote = document.getElementById(`testimonial-quote-${index}`).value;
      const company = document.getElementById(`testimonial-company-${index}`).value;
      currentConfig.testimonials[index] = { quote, company };
    }

    function addTestimonial() {
      if (!currentConfig.testimonials) {
        currentConfig.testimonials = [];
      }
      currentConfig.testimonials.push({ quote: '', company: '' });
      renderTestimonials();
    }

    function removeTestimonial(index) {
      currentConfig.testimonials.splice(index, 1);
      renderTestimonials();
    }

    async function saveConfig() {
      const password = sessionStorage.getItem('adminPass');
      if (!password) {
        alert('Please log in again');
        return;
      }

      // Gather form data
      const config = {
        stats: {
          subscribers: document.getElementById('cfg-subscribers').value,
          openRate: document.getElementById('cfg-openrate').value
        },
        pricing: currentConfig.pricing || { premium: 500, unclassified: 200 },
        contact: {
          email: document.getElementById('cfg-email').value
        },
        testimonials: currentConfig.testimonials || []
      };

      const btn = document.querySelector('.save-config-btn');
      const status = document.getElementById('saveStatus');
      btn.disabled = true;
      btn.textContent = 'Saving...';
      status.textContent = '';

      try {
        const response = await fetch(`${WORKER_URL}/admin/config`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(config)
        });

        if (!response.ok) {
          throw new Error('Failed to save');
        }

        currentConfig = config;
        status.textContent = 'Saved!';
        status.className = 'save-status success';
        setTimeout(() => { status.textContent = ''; }, 3000);

      } catch (err) {
        console.error('Save error:', err);
        status.textContent = 'Failed to save';
        status.className = 'save-status error';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Changes';
      }
    }

    // Check for saved session
    const savedPass = sessionStorage.getItem('adminPass');
    if (savedPass) {
      fetchOrders(savedPass);
      fetchConfig();
    }
  </script>
</body>
</html>
