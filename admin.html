<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin â€” Recomendo Ads</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 20px 0; }

    /* Login */
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 100px auto;
    }
    .login-box h2 { margin: 0 0 20px 0; }
    .login-box input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .login-box button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #8fd14f;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .login-box button:hover { background: #7ac043; }
    .error { color: #e74c3c; margin-top: 10px; }

    /* Dashboard */
    .dashboard { display: none; }
    .dashboard.visible { display: block; }
    .login-box.hidden { display: none; }

    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 1;
    }
    .stat-card .number {
      font-size: 32px;
      font-weight: 700;
      color: #8fd14f;
    }
    .stat-card .label { color: #666; }

    .orders-table {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .orders-table h2 {
      margin: 0;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 15px 20px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th { background: #fafafa; font-weight: 600; }
    tr:hover { background: #fafafa; }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.premium { background: #ffe600; color: #333; }
    .badge.unclassified { background: #e0e0e0; color: #333; }

    .ad-copy {
      max-width: 300px;
      font-size: 13px;
      color: #555;
      line-height: 1.4;
    }
    .ad-copy a {
      color: #8fd14f;
      text-decoration: underline;
    }
    .issue-date { white-space: nowrap; }

    .loading { text-align: center; padding: 40px; color: #666; }
    .no-orders { text-align: center; padding: 40px; color: #666; }

    .delete-btn {
      background: none;
      border: 1px solid #ddd;
      color: #999;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn:hover {
      background: #fee;
      border-color: #e74c3c;
      color: #e74c3c;
    }
    .delete-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .logout-btn {
      background: none;
      border: 1px solid #ddd;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      float: right;
    }
    .logout-btn:hover { background: #f5f5f5; }

    @media (max-width: 700px) {
      .stats-bar { flex-direction: column; }
      table { font-size: 14px; }
      th, td { padding: 10px; }
      .ad-copy { max-width: 150px; }
    }

    /* Config Editor */
    .config-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 30px;
      overflow: hidden;
    }
    .config-section h2 {
      margin: 0;
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .config-content { padding: 20px; }
    .config-group {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #eee;
    }
    .config-group:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .config-group h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      text-transform: uppercase;
      color: #888;
      letter-spacing: 0.5px;
    }
    .config-row {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }
    .config-field {
      flex: 1;
    }
    .config-field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #555;
    }
    .config-field input, .config-field textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }
    .config-field textarea {
      min-height: 80px;
      resize: vertical;
    }
    .config-field input:focus, .config-field textarea:focus {
      outline: none;
      border-color: #8fd14f;
    }
    .testimonial-card-edit {
      background: #f9f9f9;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
    }
    .testimonial-card-edit .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 18px;
    }
    .testimonial-card-edit .remove-btn:hover { color: #e74c3c; }
    .add-testimonial-btn {
      background: #f5f5f5;
      border: 2px dashed #ddd;
      padding: 12px;
      border-radius: 6px;
      width: 100%;
      cursor: pointer;
      font-size: 14px;
      color: #666;
    }
    .add-testimonial-btn:hover {
      border-color: #8fd14f;
      color: #333;
    }
    .save-config-btn {
      background: #8fd14f;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
    .save-config-btn:hover { background: #7ac043; }
    .save-config-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .save-status {
      display: inline-block;
      margin-left: 12px;
      font-size: 14px;
    }
    .save-status.success { color: #27ae60; }
    .save-status.error { color: #e74c3c; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login -->
    <div class="login-box" id="loginBox">
      <h2>Admin Login</h2>
      <input type="password" id="password" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Login</button>
      <div class="error" id="loginError"></div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
      <h1>Upcoming Ads <button class="logout-btn" onclick="logout()">Logout</button></h1>

      <div class="stats-bar">
        <div class="stat-card">
          <div class="number" id="totalOrders">-</div>
          <div class="label">Total Bookings</div>
        </div>
        <div class="stat-card">
          <div class="number" id="totalRevenue">-</div>
          <div class="label">Revenue</div>
        </div>
        <div class="stat-card">
          <div class="number" id="upcomingAds">-</div>
          <div class="label">Upcoming Ads</div>
        </div>
      </div>

      <div class="orders-table">
        <h2>Ad Schedule</h2>
        <div id="ordersContent">
          <div class="loading">Loading orders...</div>
        </div>
      </div>

      <!-- Site Settings -->
      <div class="config-section">
        <h2>
          Site Settings
          <div>
            <button class="save-config-btn" onclick="saveConfig()">Save Changes</button>
            <span class="save-status" id="saveStatus"></span>
          </div>
        </h2>
        <div class="config-content">
          <!-- Stats -->
          <div class="config-group">
            <h3>Newsletter Stats</h3>
            <div class="config-row">
              <div class="config-field">
                <label>Subscribers</label>
                <input type="text" id="cfg-subscribers" placeholder="e.g. 122,000+">
              </div>
              <div class="config-field">
                <label>Open Rate</label>
                <input type="text" id="cfg-openrate" placeholder="e.g. 46%">
              </div>
            </div>
          </div>

          <!-- Contact -->
          <div class="config-group">
            <h3>Contact</h3>
            <div class="config-row">
              <div class="config-field">
                <label>Contact Email</label>
                <input type="email" id="cfg-email" placeholder="e.g. editor@kk.org">
              </div>
            </div>
          </div>

          <!-- Testimonials -->
          <div class="config-group">
            <h3>Testimonials</h3>
            <div id="testimonialsList"></div>
            <button class="add-testimonial-btn" onclick="addTestimonial()">+ Add Testimonial</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://recomendo-ads-checkout.markfrauenfelder.workers.dev';

    function login() {
      const password = document.getElementById('password').value;
      if (!password) return;

      // Store password and try to fetch orders
      sessionStorage.setItem('adminPass', password);
      fetchOrders(password);
      fetchConfig();
    }

    function logout() {
      sessionStorage.removeItem('adminPass');
      document.getElementById('loginBox').classList.remove('hidden');
      document.getElementById('dashboard').classList.remove('visible');
      document.getElementById('password').value = '';
    }

    async function fetchOrders(password) {
      try {
        const response = await fetch(`${WORKER_URL}/admin/orders`, {
          headers: {
            'Authorization': `Bearer ${password}`
          }
        });

        if (response.status === 401) {
          document.getElementById('loginError').textContent = 'Invalid password';
          sessionStorage.removeItem('adminPass');
          return;
        }

        if (!response.ok) throw new Error('Failed to fetch');

        const data = await response.json();

        // Show dashboard
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('dashboard').classList.add('visible');
        document.getElementById('loginError').textContent = '';

        renderOrders(data);
      } catch (err) {
        document.getElementById('loginError').textContent = 'Error connecting to server';
        console.error(err);
      }
    }

    function renderOrders(data) {
      const { orders, stats } = data;

      // Update stats
      document.getElementById('totalOrders').textContent = stats.totalOrders;
      document.getElementById('totalRevenue').textContent = '$' + stats.totalRevenue.toLocaleString();
      document.getElementById('upcomingAds').textContent = stats.upcomingAds;

      if (orders.length === 0) {
        document.getElementById('ordersContent').innerHTML = '<div class="no-orders">No orders yet</div>';
        return;
      }

      // Sort by issue date
      orders.sort((a, b) => new Date(a.issueDate) - new Date(b.issueDate));

      let html = `<table>
        <thead>
          <tr>
            <th>Issue Date</th>
            <th>Type</th>
            <th>Customer</th>
            <th>Ad Copy</th>
            <th>Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>`;

      for (const order of orders) {
        const badgeClass = order.type === 'premium' ? 'premium' : 'unclassified';
        const typeName = order.type === 'premium' ? 'Premium' : 'Unclassified';

        html += `<tr id="row-${order.adId}">
          <td class="issue-date">
            <strong>#${order.issueNumber}</strong><br>
            ${order.dateFormatted}
          </td>
          <td><span class="badge ${badgeClass}">${typeName}</span></td>
          <td>
            <strong>${escapeHtml(order.customerName)}</strong><br>
            <span style="color:#666;font-size:13px">${escapeHtml(order.customerEmail)}</span>
          </td>
          <td>
            <div class="ad-copy">${formatAdCopy(order.adCopy, order.adUrl)}</div>
          </td>
          <td><strong>$${order.price}</strong></td>
          <td><button class="delete-btn" onclick="deleteAd('${order.adId}')">Delete</button></td>
        </tr>`;
      }

      html += '</tbody></table>';
      document.getElementById('ordersContent').innerHTML = html;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatAdCopy(text, url) {
      if (!text) return '';
      // Escape HTML first
      let formatted = escapeHtml(text);
      // Convert **text** to <strong>text</strong>
      formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Convert [[text]] to a link
      if (url) {
        formatted = formatted.replace(/\[\[(.+?)\]\]/g, `<a href="${escapeHtml(url)}" target="_blank">$1</a>`);
      } else {
        formatted = formatted.replace(/\[\[(.+?)\]\]/g, '<span style="color:#8fd14f;text-decoration:underline;">$1</span>');
      }
      return formatted;
    }

    async function deleteAd(adId) {
      if (!confirm('Delete this ad from the schedule? This cannot be undone.')) {
        return;
      }

      const password = sessionStorage.getItem('adminPass');
      if (!password) {
        alert('Please log in again');
        logout();
        return;
      }

      // Disable the button
      const btn = document.querySelector(`#row-${adId} .delete-btn`);
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Deleting...';
      }

      try {
        const response = await fetch(`${WORKER_URL}/admin/delete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ adId })
        });

        if (!response.ok) {
          throw new Error('Failed to delete');
        }

        // Remove the row from the table
        const row = document.getElementById(`row-${adId}`);
        if (row) {
          row.style.opacity = '0.5';
          row.style.textDecoration = 'line-through';
          setTimeout(() => row.remove(), 500);
        }

        // Update the upcoming ads count
        const countEl = document.getElementById('upcomingAds');
        const currentCount = parseInt(countEl.textContent) || 0;
        countEl.textContent = Math.max(0, currentCount - 1);

      } catch (err) {
        alert('Failed to delete ad');
        console.error(err);
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Delete';
        }
      }
    }

    // ============================================
    // CONFIG EDITOR
    // ============================================

    let currentConfig = null;

    async function fetchConfig() {
      const password = sessionStorage.getItem('adminPass');
      try {
        const response = await fetch(`${WORKER_URL}/config`);
        if (response.ok) {
          currentConfig = await response.json();
          renderConfigForm();
        }
      } catch (err) {
        console.error('Failed to fetch config:', err);
      }
    }

    function renderConfigForm() {
      if (!currentConfig) return;

      // Populate stats
      document.getElementById('cfg-subscribers').value = currentConfig.stats?.subscribers || '';
      document.getElementById('cfg-openrate').value = currentConfig.stats?.openRate || '';

      // Populate contact
      document.getElementById('cfg-email').value = currentConfig.contact?.email || '';

      // Populate testimonials
      renderTestimonials();
    }

    function renderTestimonials() {
      const container = document.getElementById('testimonialsList');
      const testimonials = currentConfig.testimonials || [];

      container.innerHTML = testimonials.map((t, i) => `
        <div class="testimonial-card-edit" data-index="${i}">
          <button class="remove-btn" onclick="removeTestimonial(${i})">&times;</button>
          <div class="config-field" style="margin-bottom:12px">
            <label>Quote</label>
            <textarea id="testimonial-quote-${i}" onchange="updateTestimonial(${i})">${escapeHtml(t.quote)}</textarea>
          </div>
          <div class="config-field">
            <label>Company</label>
            <input type="text" id="testimonial-company-${i}" value="${escapeHtml(t.company)}" onchange="updateTestimonial(${i})">
          </div>
        </div>
      `).join('');
    }

    function updateTestimonial(index) {
      const quote = document.getElementById(`testimonial-quote-${index}`).value;
      const company = document.getElementById(`testimonial-company-${index}`).value;
      currentConfig.testimonials[index] = { quote, company };
    }

    function addTestimonial() {
      if (!currentConfig.testimonials) {
        currentConfig.testimonials = [];
      }
      currentConfig.testimonials.push({ quote: '', company: '' });
      renderTestimonials();
    }

    function removeTestimonial(index) {
      currentConfig.testimonials.splice(index, 1);
      renderTestimonials();
    }

    async function saveConfig() {
      const password = sessionStorage.getItem('adminPass');
      if (!password) {
        alert('Please log in again');
        return;
      }

      // Gather form data
      const config = {
        stats: {
          subscribers: document.getElementById('cfg-subscribers').value,
          openRate: document.getElementById('cfg-openrate').value
        },
        pricing: currentConfig.pricing || { premium: 500, unclassified: 200 },
        contact: {
          email: document.getElementById('cfg-email').value
        },
        testimonials: currentConfig.testimonials || []
      };

      const btn = document.querySelector('.save-config-btn');
      const status = document.getElementById('saveStatus');
      btn.disabled = true;
      btn.textContent = 'Saving...';
      status.textContent = '';

      try {
        const response = await fetch(`${WORKER_URL}/admin/config`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(config)
        });

        if (!response.ok) {
          throw new Error('Failed to save');
        }

        currentConfig = config;
        status.textContent = 'Saved!';
        status.className = 'save-status success';
        setTimeout(() => { status.textContent = ''; }, 3000);

      } catch (err) {
        console.error('Save error:', err);
        status.textContent = 'Failed to save';
        status.className = 'save-status error';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Changes';
      }
    }

    // Check for saved session
    const savedPass = sessionStorage.getItem('adminPass');
    if (savedPass) {
      fetchOrders(savedPass);
      fetchConfig();
    }
  </script>
</body>
</html>
