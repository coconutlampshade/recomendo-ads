<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin ‚Äî Recomendo Ads</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 20px 0; }

    /* Login */
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 100px auto;
    }
    .login-box h2 { margin: 0 0 20px 0; }
    .login-box input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .login-box button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #8fd14f;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .login-box button:hover { background: #7ac043; }
    .error { color: #e74c3c; margin-top: 10px; }

    /* Dashboard */
    .dashboard { display: none; }
    .dashboard.visible { display: block; }
    .login-box.hidden { display: none; }

    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 1;
    }
    .stat-card .number {
      font-size: 32px;
      font-weight: 700;
      color: #8fd14f;
    }
    .stat-card .label { color: #666; }

    .orders-table {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .orders-table h2 {
      margin: 0;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 15px 20px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th { background: #fafafa; font-weight: 600; }
    tr:hover { background: #fafafa; }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.premium { background: #ffe600; color: #333; }
    .badge.unclassified { background: #e0e0e0; color: #333; }

    .ad-copy {
      max-width: 300px;
      font-size: 13px;
      color: #555;
      line-height: 1.4;
    }
    .ad-copy a {
      color: #8fd14f;
      text-decoration: underline;
    }
    .issue-date { white-space: nowrap; }

    .notes-indicator {
      display: inline-block;
      background: #fff3cd;
      color: #856404;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-top: 4px;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .notes-indicator:before {
      content: "üìù ";
    }

    .loading { text-align: center; padding: 40px; color: #666; }
    .no-orders { text-align: center; padding: 40px; color: #666; }

    .action-btn {
      background: none;
      border: 1px solid #ddd;
      color: #666;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 4px;
      margin-bottom: 4px;
    }
    .action-btn:hover {
      background: #f5f5f5;
      border-color: #999;
    }
    .action-btn.copy:hover {
      background: #e8f5e9;
      border-color: #8fd14f;
      color: #333;
    }
    .action-btn.edit:hover {
      background: #fff8e1;
      border-color: #f9a825;
      color: #333;
    }
    .action-btn.email:hover {
      background: #e3f2fd;
      border-color: #2196f3;
      color: #1976d2;
    }
    .action-btn.delete:hover {
      background: #fee;
      border-color: #e74c3c;
      color: #e74c3c;
    }
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .actions-cell {
      white-space: nowrap;
    }

    /* Edit Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.visible {
      display: flex;
    }
    .modal {
      background: white;
      border-radius: 8px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal h3 {
      margin: 0 0 16px 0;
    }
    .modal .form-group {
      margin-bottom: 16px;
    }
    .modal label {
      display: block;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      color: #555;
    }
    .modal input, .modal textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }
    .modal textarea {
      min-height: 100px;
      resize: vertical;
    }
    .modal-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    .modal-btn {
      padding: 10px 20px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .modal-btn.cancel {
      background: #f5f5f5;
      border: 1px solid #ddd;
      color: #666;
    }
    .modal-btn.save {
      background: #8fd14f;
      border: none;
      color: #333;
    }
    .modal-btn.save:hover {
      background: #7ac043;
    }

    .logout-btn {
      background: none;
      border: 1px solid #ddd;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      float: right;
    }
    .logout-btn:hover { background: #f5f5f5; }

    @media (max-width: 700px) {
      .stats-bar { flex-direction: column; }
      table { font-size: 14px; }
      th, td { padding: 10px; }
      .ad-copy { max-width: 150px; }
    }

    /* Config Editor */
    .config-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 30px;
      overflow: hidden;
    }
    .config-section h2 {
      margin: 0;
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .config-content { padding: 20px; }
    .config-group {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #eee;
    }
    .config-group:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .config-group h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      text-transform: uppercase;
      color: #888;
      letter-spacing: 0.5px;
    }
    .config-row {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }
    .config-field {
      flex: 1;
    }
    .config-field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #555;
    }
    .config-field input, .config-field textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }
    .config-field textarea {
      min-height: 80px;
      resize: vertical;
    }
    .config-field input:focus, .config-field textarea:focus {
      outline: none;
      border-color: #8fd14f;
    }
    .testimonial-card-edit {
      background: #f9f9f9;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
    }
    .testimonial-card-edit .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 18px;
    }
    .testimonial-card-edit .remove-btn:hover { color: #e74c3c; }
    .add-testimonial-btn {
      background: #f5f5f5;
      border: 2px dashed #ddd;
      padding: 12px;
      border-radius: 6px;
      width: 100%;
      cursor: pointer;
      font-size: 14px;
      color: #666;
    }
    .add-testimonial-btn:hover {
      border-color: #8fd14f;
      color: #333;
    }
    .save-config-btn {
      background: #8fd14f;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
    .save-config-btn:hover { background: #7ac043; }
    .save-config-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .save-status {
      display: inline-block;
      margin-left: 12px;
      font-size: 14px;
    }
    .save-status.success { color: #27ae60; }
    .save-status.error { color: #e74c3c; }

    /* Time Filter (Upcoming/Past) */
    .time-filter {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .time-filter button {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      color: #666;
    }
    .time-filter button.active {
      background: #333;
      border-color: #333;
      color: white;
    }
    .time-filter button .count {
      background: rgba(0,0,0,0.1);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
      margin-left: 4px;
    }
    .time-filter button.active .count {
      background: rgba(255,255,255,0.2);
    }
    .time-filter button.needs-report {
      border-color: #f39c12;
      color: #f39c12;
    }
    .time-filter button.needs-report.active {
      background: #f39c12;
      border-color: #f39c12;
      color: white;
    }

    /* Report Modal */
    .report-preview {
      background: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 16px;
      margin-top: 16px;
    }
    .report-preview h4 {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #888;
      text-transform: uppercase;
    }
    .report-stats {
      display: flex;
      gap: 24px;
      margin-bottom: 12px;
    }
    .report-stat {
      text-align: center;
    }
    .report-stat .value {
      font-size: 28px;
      font-weight: 700;
      color: #8fd14f;
    }
    .report-stat .label {
      font-size: 12px;
      color: #666;
    }
    .report-recipient {
      font-size: 13px;
      color: #666;
    }
    .modal-btn.send {
      background: #f39c12;
      border: none;
      color: white;
    }
    .modal-btn.send:hover {
      background: #e67e22;
    }
    .report-sent-badge {
      display: inline-block;
      background: #27ae60;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 6px;
    }

    /* Issue View */
    .issue-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .issue-header {
      background: #f8f8f8;
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .issue-title {
      font-weight: 700;
      font-size: 18px;
    }
    .issue-title span {
      color: #666;
      font-weight: 400;
      font-size: 14px;
      margin-left: 8px;
    }
    .issue-meta {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .issue-count {
      background: #e8e8e8;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: #666;
    }
    .copy-all-btn {
      background: #8fd14f;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
    }
    .copy-all-btn:hover { background: #7ac043; }
    .issue-ads {
      padding: 16px 20px;
    }
    .issue-ad-item {
      display: flex;
      gap: 16px;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
      align-items: flex-start;
    }
    .issue-ad-item:last-child {
      border-bottom: none;
    }
    .issue-ad-type {
      min-width: 100px;
    }
    .issue-ad-content {
      flex: 1;
      font-size: 14px;
      line-height: 1.5;
    }
    .issue-ad-content a {
      color: #8fd14f;
      text-decoration: underline;
    }
    .issue-ad-customer {
      min-width: 150px;
      font-size: 13px;
      color: #666;
      text-align: right;
    }
    .issue-ad-actions {
      display: flex;
      gap: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login -->
    <div class="login-box" id="loginBox">
      <h2>Admin Login</h2>
      <input type="password" id="password" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Login</button>
      <div class="error" id="loginError"></div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
      <h1>Upcoming Ads <button class="logout-btn" onclick="logout()">Logout</button></h1>

      <div class="stats-bar">
        <div class="stat-card">
          <div class="number" id="totalOrders">-</div>
          <div class="label">Total Bookings</div>
        </div>
        <div class="stat-card">
          <div class="number" id="totalRevenue">-</div>
          <div class="label">Revenue</div>
        </div>
        <div class="stat-card">
          <div class="number" id="upcomingAds">-</div>
          <div class="label">Upcoming Ads</div>
        </div>
      </div>

      <div class="time-filter">
        <button class="active" onclick="switchTimeFilter('upcoming')">
          Upcoming <span class="count" id="upcomingCount">0</span>
        </button>
        <button onclick="switchTimeFilter('past')">
          Past <span class="count" id="pastCount">0</span>
        </button>
        <button class="needs-report" onclick="switchTimeFilter('needsReport')">
          Needs Report <span class="count" id="needsReportCount">0</span>
        </button>
      </div>

      <div id="issueViewContent">
        <div class="loading">Loading orders...</div>
      </div>

      <!-- Site Settings -->
      <div class="config-section">
        <h2>
          Site Settings
          <div>
            <button class="save-config-btn" onclick="saveConfig()">Save Changes</button>
            <span class="save-status" id="saveStatus"></span>
          </div>
        </h2>
        <div class="config-content">
          <!-- Stats -->
          <div class="config-group">
            <h3>Newsletter Stats</h3>
            <div class="config-row">
              <div class="config-field">
                <label>Subscribers</label>
                <input type="text" id="cfg-subscribers" placeholder="e.g. 122,000+">
              </div>
              <div class="config-field">
                <label>Open Rate</label>
                <input type="text" id="cfg-openrate" placeholder="e.g. 46%">
              </div>
            </div>
          </div>

          <!-- Contact -->
          <div class="config-group">
            <h3>Contact</h3>
            <div class="config-row">
              <div class="config-field">
                <label>Contact Email</label>
                <input type="email" id="cfg-email" placeholder="e.g. editor@kk.org">
              </div>
            </div>
          </div>

          <!-- Testimonials -->
          <div class="config-group">
            <h3>Testimonials</h3>
            <div id="testimonialsList"></div>
            <button class="add-testimonial-btn" onclick="addTestimonial()">+ Add Testimonial</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
      <div class="modal">
        <h3>Edit Ad</h3>
        <input type="hidden" id="edit-adId">
        <div class="form-group">
          <label>Ad Copy</label>
          <textarea id="edit-adCopy" placeholder="Use **bold** and [[link text]]"></textarea>
        </div>
        <div class="form-group">
          <label>Destination URL</label>
          <input type="url" id="edit-adUrl" placeholder="https://example.com">
        </div>
        <div class="form-group">
          <label>Preview</label>
          <div id="edit-preview" style="background:#f5f5f5;padding:12px;border-radius:4px;font-size:14px;line-height:1.5;min-height:40px;"></div>
        </div>
        <div class="form-group">
          <label>Internal Notes <span style="font-weight:normal;color:#999;">(only visible to you)</span></label>
          <textarea id="edit-notes" placeholder="e.g. VIP customer, requested change, follow up needed..."></textarea>
        </div>
        <div class="modal-buttons">
          <button class="modal-btn cancel" onclick="closeEditModal()">Cancel</button>
          <button class="modal-btn save" onclick="saveEdit()">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="reportModal">
      <div class="modal">
        <h3>Send Performance Report</h3>
        <input type="hidden" id="report-adId">
        <input type="hidden" id="report-customerName">
        <input type="hidden" id="report-customerEmail">
        <input type="hidden" id="report-issueNumber">
        <input type="hidden" id="report-dateFormatted">
        <input type="hidden" id="report-adType">

        <p style="color:#666;margin:0 0 16px;">Enter the performance stats from Substack for this ad:</p>

        <div class="form-group">
          <label>Ad Details</label>
          <div id="report-adInfo" style="background:#f5f5f5;padding:12px;border-radius:4px;font-size:14px;"></div>
        </div>

        <div style="display:flex;gap:16px;">
          <div class="form-group" style="flex:1">
            <label>Link Clicks <span style="color:#e74c3c;">*</span></label>
            <input type="number" id="report-clicks" placeholder="e.g. 342" min="0" oninput="updateReportPreview()">
          </div>
          <div class="form-group" style="flex:1">
            <label>Open Rate %</label>
            <input type="number" id="report-openRate" placeholder="e.g. 46" min="0" max="100" value="46" oninput="updateReportPreview()">
          </div>
        </div>

        <div class="report-preview">
          <h4>Email Preview</h4>
          <div class="report-stats">
            <div class="report-stat">
              <div class="value" id="preview-clicks">‚Äî</div>
              <div class="label">Link Clicks</div>
            </div>
            <div class="report-stat">
              <div class="value" id="preview-openRate">46%</div>
              <div class="label">Open Rate</div>
            </div>
          </div>
          <div class="report-recipient">
            To: <strong id="preview-recipient"></strong>
          </div>
        </div>

        <div class="modal-buttons">
          <button class="modal-btn cancel" onclick="closeReportModal()">Cancel</button>
          <button class="modal-btn send" onclick="sendReport()" id="sendReportBtn">Send Report</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://recomendo-ads-checkout.markfrauenfelder.workers.dev';

    function login() {
      const password = document.getElementById('password').value;
      if (!password) return;

      // Store password and try to fetch orders
      sessionStorage.setItem('adminPass', password);
      fetchOrders(password);
      fetchConfig();
    }

    function logout() {
      sessionStorage.removeItem('adminPass');
      document.getElementById('loginBox').classList.remove('hidden');
      document.getElementById('dashboard').classList.remove('visible');
      document.getElementById('password').value = '';
    }

    async function fetchOrders(password) {
      try {
        const response = await fetch(`${WORKER_URL}/admin/orders`, {
          headers: {
            'Authorization': `Bearer ${password}`
          }
        });

        if (response.status === 401) {
          document.getElementById('loginError').textContent = 'Invalid password';
          sessionStorage.removeItem('adminPass');
          return;
        }

        if (!response.ok) throw new Error('Failed to fetch');

        const data = await response.json();

        // Show dashboard
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('dashboard').classList.add('visible');
        document.getElementById('loginError').textContent = '';

        // Store data globally for filtering
        window.allOrdersData = data;
        renderOrders(data);
      } catch (err) {
        document.getElementById('loginError').textContent = 'Error connecting to server';
        console.error(err);
      }
    }

    let currentTimeFilter = 'upcoming';

    function switchTimeFilter(filter) {
      currentTimeFilter = filter;
      const buttons = document.querySelectorAll('.time-filter button');
      buttons.forEach(btn => btn.classList.remove('active'));

      if (filter === 'upcoming') {
        buttons[0].classList.add('active');
      } else if (filter === 'past') {
        buttons[1].classList.add('active');
      } else if (filter === 'needsReport') {
        buttons[2].classList.add('active');
      }

      if (window.allOrdersData) {
        if (filter === 'upcoming') {
          renderIssueView(window.allOrdersData.orders);
        } else if (filter === 'past') {
          renderIssueView(window.allOrdersData.pastOrders);
        } else if (filter === 'needsReport') {
          renderIssueView(window.allOrdersData.needsReportOrders, true);
        }
      }
    }

    function renderOrders(data) {
      const { orders, pastOrders = [], stats } = data;

      // Update stats
      document.getElementById('totalOrders').textContent = stats.totalOrders;
      document.getElementById('totalRevenue').textContent = '$' + stats.totalRevenue.toLocaleString();
      document.getElementById('upcomingAds').textContent = stats.upcomingAds;

      // Calculate ads that need reports (7+ days old, report not sent)
      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const needsReportOrders = pastOrders.filter(order => {
        if (order.reportSent) return false;
        if (!order.issueDate) return false;
        try {
          const issueDate = new Date(order.issueDate);
          return issueDate <= sevenDaysAgo;
        } catch {
          return false;
        }
      });

      // Store needs report orders
      data.needsReportOrders = needsReportOrders;

      // Update time filter counts
      document.getElementById('upcomingCount').textContent = orders.length;
      document.getElementById('pastCount').textContent = pastOrders.length;
      document.getElementById('needsReportCount').textContent = needsReportOrders.length;

      // Store all order data for copy/edit
      window.orderData = window.orderData || {};
      for (const order of [...orders, ...pastOrders]) {
        window.orderData[order.adId] = order;
      }

      // Render current filter
      if (currentTimeFilter === 'upcoming') {
        renderIssueView(orders);
      } else if (currentTimeFilter === 'past') {
        renderIssueView(pastOrders);
      } else if (currentTimeFilter === 'needsReport') {
        renderIssueView(needsReportOrders, true);
      }
    }

    function renderIssueView(orders, showReportButton = false) {
      if (orders.length === 0) {
        const message = currentTimeFilter === 'needsReport'
          ? 'No ads need reports right now'
          : `No ${currentTimeFilter} ads`;
        document.getElementById('issueViewContent').innerHTML = `<div class="no-orders">${message}</div>`;
        return;
      }

      // Group orders by issue number
      const issueGroups = {};
      for (const order of orders) {
        const key = order.issueNumber;
        if (!issueGroups[key]) {
          issueGroups[key] = {
            issueNumber: order.issueNumber,
            dateFormatted: order.dateFormatted,
            issueDate: order.issueDate,
            ads: []
          };
        }
        issueGroups[key].ads.push(order);
      }

      // Sort issues by date
      const sortedIssues = Object.values(issueGroups).sort((a, b) =>
        new Date(a.issueDate) - new Date(b.issueDate)
      );

      let html = '';
      for (const issue of sortedIssues) {
        const premiumCount = issue.ads.filter(a => a.type === 'premium').length;
        const unclassifiedCount = issue.ads.filter(a => a.type === 'unclassified').length;

        html += `
          <div class="issue-card" data-issue="${issue.issueNumber}">
            <div class="issue-header">
              <div class="issue-title">
                Issue #${issue.issueNumber}
                <span>${issue.dateFormatted}</span>
              </div>
              <div class="issue-meta">
                <span class="issue-count">
                  ${premiumCount ? premiumCount + ' Premium' : ''}
                  ${premiumCount && unclassifiedCount ? ' ¬∑ ' : ''}
                  ${unclassifiedCount ? unclassifiedCount + ' Unclassified' : ''}
                </span>
                <button class="copy-all-btn" onclick="copyAllForIssue('${issue.issueNumber}')">Copy All</button>
              </div>
            </div>
            <div class="issue-ads">`;

        // Sort ads: premium first, then unclassified
        const sortedAds = [...issue.ads].sort((a, b) => {
          if (a.type === 'premium' && b.type !== 'premium') return -1;
          if (a.type !== 'premium' && b.type === 'premium') return 1;
          return 0;
        });

        for (const ad of sortedAds) {
          const badgeClass = ad.type === 'premium' ? 'premium' : 'unclassified';
          const typeName = ad.type === 'premium' ? 'Premium' : 'Unclassified';

          // Build report button/badge
          let reportHtml = '';
          if (showReportButton) {
            if (ad.reportSent) {
              reportHtml = `<span class="report-sent-badge">Report Sent</span>`;
            } else {
              reportHtml = `<button class="action-btn" style="background:#f39c12;color:white;border-color:#f39c12;" onclick="openReportModal('${ad.adId}')" title="Send Report">Send Report</button>`;
            }
          }

          html += `
              <div class="issue-ad-item">
                <div class="issue-ad-type">
                  <span class="badge ${badgeClass}">${typeName}</span>
                </div>
                <div class="issue-ad-content">${formatAdCopy(ad.adCopy, ad.adUrl)}${ad.notes ? `<div class="notes-indicator" title="${escapeHtml(ad.notes)}">${escapeHtml(ad.notes)}</div>` : ''}</div>
                <div class="issue-ad-customer">${escapeHtml(ad.customerName)}${reportHtml}</div>
                <div class="issue-ad-actions">
                  <button class="action-btn copy" onclick="copyAd('${ad.adId}')" title="Copy">Copy</button>
                  <button class="action-btn edit" onclick="editAd('${ad.adId}')" title="Edit">Edit</button>
                  <button class="action-btn email" onclick="emailCustomer('${ad.adId}')" title="Email">Email</button>
                  <button class="action-btn delete" onclick="deleteAd('${ad.adId}')" title="Delete">Delete</button>
                </div>
              </div>`;
        }

        html += `
            </div>
          </div>`;
      }

      document.getElementById('issueViewContent').innerHTML = html;
    }

    function copyAllForIssue(issueNumber) {
      // Find all ads for this issue
      const ads = Object.values(window.orderData || {}).filter(
        order => String(order.issueNumber) === String(issueNumber)
      );

      if (ads.length === 0) return;

      // Sort: premium first
      ads.sort((a, b) => {
        if (a.type === 'premium' && b.type !== 'premium') return -1;
        if (a.type !== 'premium' && b.type === 'premium') return 1;
        return 0;
      });

      // Build HTML for all ads
      let html = '';
      for (const ad of ads) {
        let adHtml = ad.adCopy;
        // Convert **bold** to <b>
        adHtml = adHtml.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');

        // Check if there's a [[link]] in the copy
        if (adHtml.includes('[[') && adHtml.includes(']]')) {
          adHtml = adHtml.replace(/\[\[(.+?)\]\]/g, `<a href="${ad.adUrl}">$1</a>`);
        } else if (ad.adUrl) {
          // No [[link]] syntax - append URL as a link at the end
          const displayUrl = ad.adUrl.replace(/^https?:\/\//, '').replace(/\/$/, '');
          adHtml += ` <a href="${ad.adUrl}">${displayUrl}</a>`;
        }

        if (ad.type === 'premium') {
          html += `<p><strong>[SPONSOR]</strong> ${adHtml}</p>\n`;
        } else {
          html += `<p>${adHtml}</p>\n`;
        }
      }

      // Copy as HTML
      const blob = new Blob([html], { type: 'text/html' });
      const plainBlob = new Blob([html], { type: 'text/plain' });

      navigator.clipboard.write([
        new ClipboardItem({
          'text/html': blob,
          'text/plain': plainBlob
        })
      ]).then(() => {
        const btn = document.querySelector(`.issue-card[data-issue="${issueNumber}"] .copy-all-btn`);
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = '#7ac043';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 1500);
      }).catch(err => {
        console.error('Copy failed:', err);
        navigator.clipboard.writeText(html);
        alert('Copied as plain text');
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatAdCopy(text, url) {
      if (!text) return '';
      // Escape HTML first
      let formatted = escapeHtml(text);
      // Convert **text** to <strong>text</strong>
      formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Convert [[text]] to a link
      if (url) {
        formatted = formatted.replace(/\[\[(.+?)\]\]/g, `<a href="${escapeHtml(url)}" target="_blank">$1</a>`);
      } else {
        formatted = formatted.replace(/\[\[(.+?)\]\]/g, '<span style="color:#8fd14f;text-decoration:underline;">$1</span>');
      }
      return formatted;
    }

    async function deleteAd(adId) {
      if (!confirm('Delete this ad from the schedule? This cannot be undone.')) {
        return;
      }

      const password = sessionStorage.getItem('adminPass');
      if (!password) {
        alert('Please log in again');
        logout();
        return;
      }

      // Disable the button
      const btn = document.querySelector(`#row-${adId} .delete-btn`);
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Deleting...';
      }

      try {
        const response = await fetch(`${WORKER_URL}/admin/delete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ adId })
        });

        if (!response.ok) {
          throw new Error('Failed to delete');
        }

        // Remove the row from the table
        const row = document.getElementById(`row-${adId}`);
        if (row) {
          row.style.opacity = '0.5';
          row.style.textDecoration = 'line-through';
          setTimeout(() => row.remove(), 500);
        }

        // Update the upcoming ads count
        const countEl = document.getElementById('upcomingAds');
        const currentCount = parseInt(countEl.textContent) || 0;
        countEl.textContent = Math.max(0, currentCount - 1);

      } catch (err) {
        alert('Failed to delete ad');
        console.error(err);
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Delete';
        }
      }
    }

    // ============================================
    // COPY AD
    // ============================================

    function copyAd(adId) {
      const order = window.orderData[adId];
      if (!order) return;

      // Format for newsletter: convert **bold** and [[link]] to HTML
      let html = order.adCopy;
      html = html.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');

      // Check if there's a [[link]] in the copy
      if (html.includes('[[') && html.includes(']]')) {
        html = html.replace(/\[\[(.+?)\]\]/g, `<a href="${order.adUrl}">$1</a>`);
      } else if (order.adUrl) {
        // No [[link]] syntax - append URL as a link at the end
        const displayUrl = order.adUrl.replace(/^https?:\/\//, '').replace(/\/$/, '');
        html += ` <a href="${order.adUrl}">${displayUrl}</a>`;
      }

      // Copy as HTML to clipboard
      const blob = new Blob([html], { type: 'text/html' });
      const plainBlob = new Blob([html], { type: 'text/plain' });

      navigator.clipboard.write([
        new ClipboardItem({
          'text/html': blob,
          'text/plain': plainBlob
        })
      ]).then(() => {
        // Show feedback
        const btn = document.querySelector(`#row-${adId} .action-btn.copy`);
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = '#e8f5e9';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 1500);
      }).catch(err => {
        console.error('Copy failed:', err);
        // Fallback: copy plain text
        navigator.clipboard.writeText(html);
        alert('Copied as plain text (HTML copy not supported in this browser)');
      });
    }

    // ============================================
    // EMAIL CUSTOMER
    // ============================================

    function emailCustomer(adId) {
      const order = window.orderData[adId];
      if (!order) return;

      const subject = `Your Recomendo Ad - Issue #${order.issueNumber}`;
      const body = `Hi ${order.customerName},

I'm writing about your Recomendo ad scheduled for Issue #${order.issueNumber} (${order.dateFormatted}).

Your ad copy:
${order.adCopy}

Link: ${order.adUrl}

`;

      const mailto = `mailto:${order.customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;
    }

    // ============================================
    // EDIT AD
    // ============================================

    function editAd(adId) {
      const order = window.orderData[adId];
      if (!order) return;

      document.getElementById('edit-adId').value = adId;
      document.getElementById('edit-adCopy').value = order.adCopy;
      document.getElementById('edit-adUrl').value = order.adUrl;
      document.getElementById('edit-notes').value = order.notes || '';
      updateEditPreview();

      document.getElementById('editModal').classList.add('visible');

      // Update preview on input
      document.getElementById('edit-adCopy').oninput = updateEditPreview;
      document.getElementById('edit-adUrl').oninput = updateEditPreview;
    }

    function updateEditPreview() {
      const adCopy = document.getElementById('edit-adCopy').value;
      const adUrl = document.getElementById('edit-adUrl').value;
      document.getElementById('edit-preview').innerHTML = formatAdCopy(adCopy, adUrl) || '<span style="color:#999">Preview will appear here...</span>';
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('visible');
    }

    async function saveEdit() {
      const adId = document.getElementById('edit-adId').value;
      const adCopy = document.getElementById('edit-adCopy').value;
      const adUrl = document.getElementById('edit-adUrl').value;
      const notes = document.getElementById('edit-notes').value;

      const password = sessionStorage.getItem('adminPass');
      if (!password) {
        alert('Please log in again');
        return;
      }

      const saveBtn = document.querySelector('.modal-btn.save');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch(`${WORKER_URL}/admin/edit`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ adId, adCopy, adUrl, notes })
        });

        if (!response.ok) {
          throw new Error('Failed to save');
        }

        // Update local data
        window.orderData[adId].adCopy = adCopy;
        window.orderData[adId].adUrl = adUrl;
        window.orderData[adId].notes = notes;

        // Update the table cell
        const adCopyEl = document.getElementById(`adcopy-${adId}`);
        if (adCopyEl) {
          let html = formatAdCopy(adCopy, adUrl);
          if (notes) {
            html += `<div class="notes-indicator" title="${escapeHtml(notes)}">${escapeHtml(notes)}</div>`;
          }
          adCopyEl.innerHTML = html;
        }

        // Re-render to show updated notes
        if (window.allOrdersData) {
          const currentOrders = currentTimeFilter === 'upcoming' ? window.allOrdersData.orders : window.allOrdersData.pastOrders;
          renderIssueView(currentOrders);
        }

        closeEditModal();
      } catch (err) {
        alert('Failed to save changes');
        console.error(err);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    }

    // Close modal on overlay click
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) closeEditModal();
    });

    // ============================================
    // REPORT MODAL
    // ============================================

    function openReportModal(adId) {
      const order = window.orderData[adId];
      if (!order) return;

      // Populate hidden fields
      document.getElementById('report-adId').value = adId;
      document.getElementById('report-customerName').value = order.customerName;
      document.getElementById('report-customerEmail').value = order.customerEmail;
      document.getElementById('report-issueNumber').value = order.issueNumber;
      document.getElementById('report-dateFormatted').value = order.dateFormatted;
      document.getElementById('report-adType').value = order.type;

      // Clear and set defaults
      document.getElementById('report-clicks').value = '';
      document.getElementById('report-openRate').value = '46';

      // Show ad info
      const typeName = order.type === 'premium' ? 'Premium Sponsorship' : 'Unclassified Ad';
      document.getElementById('report-adInfo').innerHTML = `
        <strong>${typeName}</strong> ¬∑ Issue #${order.issueNumber}<br>
        <span style="color:#666">${order.dateFormatted}</span>
      `;

      // Update preview
      document.getElementById('preview-recipient').textContent = order.customerEmail;
      updateReportPreview();

      // Show modal
      document.getElementById('reportModal').classList.add('visible');

      // Focus clicks input
      setTimeout(() => document.getElementById('report-clicks').focus(), 100);
    }

    function closeReportModal() {
      document.getElementById('reportModal').classList.remove('visible');
    }

    function updateReportPreview() {
      const clicks = document.getElementById('report-clicks').value;
      const openRate = document.getElementById('report-openRate').value;

      document.getElementById('preview-clicks').textContent = clicks || '‚Äî';
      document.getElementById('preview-openRate').textContent = (openRate || '46') + '%';
    }

    async function sendReport() {
      const adId = document.getElementById('report-adId').value;
      const clicks = document.getElementById('report-clicks').value;
      const openRate = document.getElementById('report-openRate').value || '46';

      if (!clicks) {
        alert('Please enter the number of clicks');
        document.getElementById('report-clicks').focus();
        return;
      }

      const password = sessionStorage.getItem('adminPass');
      if (!password) {
        alert('Please log in again');
        return;
      }

      const btn = document.getElementById('sendReportBtn');
      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        const response = await fetch(`${WORKER_URL}/admin/send-report`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            adId,
            customerName: document.getElementById('report-customerName').value,
            customerEmail: document.getElementById('report-customerEmail').value,
            issueNumber: document.getElementById('report-issueNumber').value,
            dateFormatted: document.getElementById('report-dateFormatted').value,
            adType: document.getElementById('report-adType').value,
            clicks: parseInt(clicks),
            openRate: parseInt(openRate)
          })
        });

        if (!response.ok) {
          throw new Error('Failed to send report');
        }

        // Update local data
        window.orderData[adId].reportSent = true;
        window.orderData[adId].reportData = { clicks, openRate, sentAt: new Date().toISOString() };

        // Update needs report count
        const countEl = document.getElementById('needsReportCount');
        const currentCount = parseInt(countEl.textContent) || 0;
        countEl.textContent = Math.max(0, currentCount - 1);

        // Re-render if on needs report tab
        if (currentTimeFilter === 'needsReport' && window.allOrdersData) {
          window.allOrdersData.needsReportOrders = window.allOrdersData.needsReportOrders.filter(o => o.adId !== adId);
          renderIssueView(window.allOrdersData.needsReportOrders, true);
        }

        closeReportModal();
        alert('Report sent successfully!');

      } catch (err) {
        alert('Failed to send report. Please try again.');
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Send Report';
      }
    }

    // Close report modal on overlay click
    document.getElementById('reportModal').addEventListener('click', function(e) {
      if (e.target === this) closeReportModal();
    });

    // ============================================
    // CONFIG EDITOR
    // ============================================

    let currentConfig = null;

    async function fetchConfig() {
      const password = sessionStorage.getItem('adminPass');
      try {
        const response = await fetch(`${WORKER_URL}/config`);
        if (response.ok) {
          currentConfig = await response.json();
          renderConfigForm();
        }
      } catch (err) {
        console.error('Failed to fetch config:', err);
      }
    }

    function renderConfigForm() {
      if (!currentConfig) return;

      // Populate stats
      document.getElementById('cfg-subscribers').value = currentConfig.stats?.subscribers || '';
      document.getElementById('cfg-openrate').value = currentConfig.stats?.openRate || '';

      // Populate contact
      document.getElementById('cfg-email').value = currentConfig.contact?.email || '';

      // Populate testimonials
      renderTestimonials();
    }

    function renderTestimonials() {
      const container = document.getElementById('testimonialsList');
      const testimonials = currentConfig.testimonials || [];

      container.innerHTML = testimonials.map((t, i) => `
        <div class="testimonial-card-edit" data-index="${i}">
          <button class="remove-btn" onclick="removeTestimonial(${i})">&times;</button>
          <div class="config-field" style="margin-bottom:12px">
            <label>Quote</label>
            <textarea id="testimonial-quote-${i}" onchange="updateTestimonial(${i})">${escapeHtml(t.quote)}</textarea>
          </div>
          <div class="config-field">
            <label>Company</label>
            <input type="text" id="testimonial-company-${i}" value="${escapeHtml(t.company)}" onchange="updateTestimonial(${i})">
          </div>
        </div>
      `).join('');
    }

    function updateTestimonial(index) {
      const quote = document.getElementById(`testimonial-quote-${index}`).value;
      const company = document.getElementById(`testimonial-company-${index}`).value;
      currentConfig.testimonials[index] = { quote, company };
    }

    function addTestimonial() {
      if (!currentConfig.testimonials) {
        currentConfig.testimonials = [];
      }
      currentConfig.testimonials.push({ quote: '', company: '' });
      renderTestimonials();
    }

    function removeTestimonial(index) {
      currentConfig.testimonials.splice(index, 1);
      renderTestimonials();
    }

    async function saveConfig() {
      const password = sessionStorage.getItem('adminPass');
      if (!password) {
        alert('Please log in again');
        return;
      }

      // Gather form data
      const config = {
        stats: {
          subscribers: document.getElementById('cfg-subscribers').value,
          openRate: document.getElementById('cfg-openrate').value
        },
        pricing: currentConfig.pricing || { premium: 500, unclassified: 200 },
        contact: {
          email: document.getElementById('cfg-email').value
        },
        testimonials: currentConfig.testimonials || []
      };

      const btn = document.querySelector('.save-config-btn');
      const status = document.getElementById('saveStatus');
      btn.disabled = true;
      btn.textContent = 'Saving...';
      status.textContent = '';

      try {
        const response = await fetch(`${WORKER_URL}/admin/config`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${password}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(config)
        });

        if (!response.ok) {
          throw new Error('Failed to save');
        }

        currentConfig = config;
        status.textContent = 'Saved!';
        status.className = 'save-status success';
        setTimeout(() => { status.textContent = ''; }, 3000);

      } catch (err) {
        console.error('Save error:', err);
        status.textContent = 'Failed to save';
        status.className = 'save-status error';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Changes';
      }
    }

    // Check for saved session
    const savedPass = sessionStorage.getItem('adminPass');
    if (savedPass) {
      fetchOrders(savedPass);
      fetchConfig();
    }
  </script>
</body>
</html>
